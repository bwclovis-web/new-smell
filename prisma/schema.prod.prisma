generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "prisma+postgres://accelerate.prisma-data.net/?api_key=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcGlfa2V5IjoiNjAyM2MyMjMtNzc1YS00MTA1LWExMmYtZWZjNzg1MjJlOWJmIiwidGVuYW50X2lkIjoiYTk4Nzc2ZTVmNzEzNWVlZWNiMzIwYTMwMjc3ZWFiNzk1ZjkxYjlmZDM3ODNlNzJmMzNlZDgwZDM2YzU0YzNjMSIsImludGVybmFsX3NlY3JldCI6IjU0NTQyODg0LTY0ZDItNGEyNS04YTgxLTY1ODgwOTUwYzFmNyJ9.kd6Lq7bADQ59I_7Kj0sKC_Co1-19NFpNx-5cMSKOG6o"
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  password              String
  firstName             String?
  lastName              String?
  username              String?                @unique
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  role                  UserRole               @default(user)
  SecurityAuditLog      SecurityAuditLog[]
  UserAlert             UserAlert[]
  alertPreferences      UserAlertPreferences?
  UserPerfume           UserPerfume[]
  userPerfumeComments   UserPerfumeComment[]
  UserPerfumeRating     UserPerfumeRating[]
  UserPerfumeReview     UserPerfumeReview[]
  UserPerfumeWishlist   UserPerfumeWishlist[]
  wishlistNotifications WishlistNotification[]
  traderFeedbackReceived TraderFeedback[] @relation("FeedbackForTrader")
  traderFeedbackLeft     TraderFeedback[] @relation("FeedbackFromReviewer")
  pendingSubmissions    PendingSubmission[] @relation("SubmittedSubmissions")
  reviewedSubmissions   PendingSubmission[] @relation("ReviewedSubmissions")
  traderContactMessagesSent TraderContactMessage[] @relation("ContactMessagesSent")
  traderContactMessagesReceived TraderContactMessage[] @relation("ContactMessagesReceived")
}

model PerfumeHouse {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  image       String?
  website     String?
  country     String?
  founded     String?
  email       String?
  phone       String?
  address     String?
  type        HouseType @default(indie)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  slug        String    @unique
  perfumes    Perfume[]

  @@index([type, name], name: "idx_house_type_name")
}

model Perfume {
  id                    String                 @id @default(cuid())
  name                  String
  description           String?
  image                 String?
  perfumeHouseId        String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  slug                  String                 @unique
  perfumeHouse          PerfumeHouse?          @relation(fields: [perfumeHouseId], references: [id])
  
  // Junction table relation
  perfumeNoteRelations  PerfumeNoteRelation[]
  
  UserAlert             UserAlert[]
  userPerfume           UserPerfume[]
  userPerfumeComments   UserPerfumeComment[]
  userPerfumeRating     UserPerfumeRating[]
  userPerfumeReview     UserPerfumeReview[]
  userPerfumeWishlist   UserPerfumeWishlist[]
  wishlistNotifications WishlistNotification[]

  @@index([slug], name: "idx_perfume_slug")
  @@index([perfumeHouseId, createdAt], name: "idx_perfume_house_created")
  @@index([name], name: "idx_perfume_name")
}

model PerfumeNotes {
  id             String   @id @default(cuid())
  name           String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt
  
  // Legacy columns (preserved from remote database)
  perfumeOpenId  String?
  perfumeHeartId String?
  perfumeCloseId String?
  
  // Junction table relation
  perfumeNoteRelations PerfumeNoteRelation[]
}

// New junction table
model PerfumeNoteRelation {
  id         String         @id @default(cuid())
  perfumeId  String
  noteId     String
  noteType   PerfumeNoteType
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @default(now()) @updatedAt
  
  perfume    Perfume        @relation(fields: [perfumeId], references: [id], onDelete: Cascade)
  note       PerfumeNotes   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  @@unique([perfumeId, noteId, noteType])
  @@index([perfumeId])
  @@index([noteId])
  @@index([noteType])
  @@index([noteId, noteType], name: "idx_note_relation_note_type")
}

model UserPerfume {
  id              String               @id @default(cuid())
  userId          String
  perfumeId       String
  amount          String               @default("0")
  available       String               @default("0")
  price           String?
  placeOfPurchase String?
  tradePrice      String?
  tradePreference TradePreference      @default(cash)
  tradeOnly       Boolean              @default(false)
  createdAt       DateTime             @default(now())
  type            PerfumeType          @default(eauDeParfum)
  perfume         Perfume              @relation(fields: [perfumeId], references: [id])
  user            User                 @relation(fields: [userId], references: [id])
  comments        UserPerfumeComment[]
}

model UserPerfumeComment {
  id            String      @id @default(cuid())
  userId        String
  perfumeId     String
  userPerfumeId String
  comment       String
  isPublic      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  perfume       Perfume     @relation(fields: [perfumeId], references: [id])
  user          User        @relation(fields: [userId], references: [id])
  userPerfume   UserPerfume @relation(fields: [userPerfumeId], references: [id])
}

model UserPerfumeRating {
  id         String   @id @default(cuid())
  userId     String
  perfumeId  String
  createdAt  DateTime @default(now())
  gender     Int?
  longevity  Int?
  overall    Int?
  priceValue Int?
  sillage    Int?
  updatedAt  DateTime
  perfume    Perfume  @relation(fields: [perfumeId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, perfumeId])
}

model UserPerfumeReview {
  id        String   @id @default(cuid())
  userId    String
  perfumeId String
  review    String
  createdAt DateTime @default(now())
  perfume   Perfume  @relation(fields: [perfumeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model UserPerfumeWishlist {
  id        String   @id @default(cuid())
  userId    String
  isPublic  Boolean  @default(false)
  perfumeId String
  createdAt DateTime @default(now())
  perfume   Perfume  @relation(fields: [perfumeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model WishlistNotification {
  id         String   @id @default(cuid())
  userId     String
  perfumeId  String
  notifiedAt DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  perfume    Perfume  @relation(fields: [perfumeId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, perfumeId])
}

model TraderFeedback {
  id          String   @id @default(cuid())
  traderId    String
  reviewerId  String
  rating      Int      /// Expected 1-5 scale; enforce in application logic.
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  trader      User     @relation("FeedbackForTrader", fields: [traderId], references: [id])
  reviewer    User     @relation("FeedbackFromReviewer", fields: [reviewerId], references: [id])

  @@unique([traderId, reviewerId])
  @@index([traderId])
  @@index([reviewerId])
}

model SecurityAuditLog {
  id         String                @id
  userId     String?
  action     SecurityAuditAction
  severity   SecurityAuditSeverity @default(info)
  resource   String?
  resourceId String?
  ipAddress  String?
  userAgent  String?
  details    Json?
  metadata   Json?
  createdAt  DateTime              @default(now())
  User       User?                 @relation(fields: [userId], references: [id])
}

model UserAlert {
  id          String    @id @default(cuid())
  userId      String
  perfumeId   String
  alertType   AlertType
  title       String
  message     String
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
  metadata    Json?
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  dismissedAt DateTime?
  Perfume     Perfume   @relation(fields: [perfumeId], references: [id])
  User        User      @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([userId, isRead, isDismissed])
}

model UserAlertPreferences {
  id                    String  @id @default(cuid())
  userId                String  @unique
  wishlistAlertsEnabled Boolean @default(true)
  decantAlertsEnabled   Boolean @default(true)
  emailWishlistAlerts   Boolean @default(false)
  emailDecantAlerts     Boolean @default(false)
  maxAlerts             Int     @default(10)
  User                  User    @relation(fields: [userId], references: [id])
}

model PendingSubmission {
  id            String                @id @default(cuid())
  submissionType PendingSubmissionType
  submittedBy   String?
  status         PendingSubmissionStatus @default(pending)
  submissionData Json
  adminNotes     String?
  reviewedBy     String?
  reviewedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  submittedByUser User?               @relation("SubmittedSubmissions", fields: [submittedBy], references: [id])
  reviewedByUser User?                @relation("ReviewedSubmissions", fields: [reviewedBy], references: [id])

  @@index([status, createdAt])
  @@index([submissionType, status])
}

model TraderContactMessage {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  subject     String?
  message     String
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  sender      User     @relation("ContactMessagesSent", fields: [senderId], references: [id])
  recipient   User     @relation("ContactMessagesReceived", fields: [recipientId], references: [id])

  @@index([senderId, createdAt])
  @@index([recipientId, createdAt])
  @@index([senderId, recipientId, createdAt])
}

// Migration state tracking for incremental syncs
model MigrationState {
  id             String   @id @default(cuid())
  tableName      String   @unique
  lastMigratedAt DateTime
  recordCount    Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum HouseType {
  niche
  designer
  indie
  celebrity
  drugstore
}

enum PerfumeType {
  eauDeParfum
  eauDeToilette
  eauDeCologne
  parfum
  extraitDeParfum
  extraitOil
  oil
  waterMist
  ipmSpray
}

enum TradePreference {
  cash
  trade
  both
}

enum UserRole {
  user
  admin
  editor
}

enum AlertType {
  wishlist_available
  decant_interest
  pending_submission_approval
}

enum PerfumeNoteType {
  open
  heart
  base
}

enum PendingSubmissionType {
  perfume
  perfume_house
}

enum PendingSubmissionStatus {
  pending
  approved
  rejected
}

enum SecurityAuditAction {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGE
  PROFILE_UPDATE
  ADMIN_ACCESS
  DATA_ACCESS
  DATA_MODIFICATION
  DATA_DELETION
  SUSPICIOUS_ACTIVITY
  RATE_LIMIT_EXCEEDED
  INVALID_TOKEN
  UNAUTHORIZED_ACCESS
  CSRF_VIOLATION
  SQL_INJECTION_ATTEMPT
  XSS_ATTEMPT
  FILE_UPLOAD
  API_ACCESS
  SYSTEM_ERROR
  SECURITY_SCAN
}

enum SecurityAuditSeverity {
  low
  info
  warning
  error
  critical
}
